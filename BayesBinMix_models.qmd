---
title: "BayesBinMix Census Data Results Summarized"
author: "Carmen B. Rodriguez"
format: 
  html:
    self-contained: TRUE
editor: visual
---

```{r}
#| warning: false
#| output: false
#Load packages
library(tidyverse)
library(Hmisc)
library(reshape2)
library(ggplot2)
library(psych)
library(table1)
library(tableone)
library(Hmisc)
library(BayesBinMix)
library(foreach)
library(label.switching)
library(doParallel)
library(coda)
library(DescTools)
library(MCMCvis)
library(knitr)
```

```{r}
#Load census data
censusdata_bin <- readRDS("./censusdata_bin.rds")
names(censusdata_bin) <- c("acs5_2010_bin","acs5_2015_bin","acs5_2019_bin")

```

The dimensionality of the multivariate distribution is equal to $d = 14$.

The following prior assumptions are imposed

$$K \sim \text{Truncated Poisson}(\lambda = 1)$$

$$p|K \sim \text{Dirichlet}(1,..., 1_K)$$ We set $\gamma_1=...= \gamma_K =\gamma > 0$ so that prior assumptions do not impose any particular information that separates the mixture components between them.

$$\theta_{kj} \sim \text{Beta}(\alpha=1, \beta=1)$$

## Run models

We will run models with different values of $K_{max}$ . That is, we will look at output where the upper bound on $K$ is `K= c(5,10,15)` .

```{r}
#Load model results--will be stored in GitHub
res_acs10<- readRDS("./ACS10_results.rds")
res_5<-res_acs10[[1]]
res_10<-res_acs10[[3]]
res_15<-res_acs10[[5]]
```

| **Kmax** | **Cluster Prior**     | **Most Probable K (mapK)** | **DIC** |
|----------|-----------------------|----------------------------|---------|
| 5        | Truncated Poisson (1) | 5                          |         |
| 10       | Truncated Poisson (1) | 4                          |         |
| 15       | Truncated Poisson (1) | 6                          |         |

: **Table 1.** Results of ACS 2006-2010

```{r}
#| echo: true
#| eval: true
#| output: false
res_all <- readRDS("./ACS15_19_results.rds")

#ACS 2015
res_acs15_5<-res_all$res_acs15_5
res_acs15_10<-res_all$res_acs15_10
res_acs15_15<-res_all$res_acs15_15

Mode(res_acs15_5$K.mcmc)[1]
Mode(res_acs15_10$K.mcmc)[1]
Mode(res_acs15_15$K.mcmc)[1]
```

| **Kmax** | **Cluster Prior**     | **Most Probable K (mapK)** |
|----------|-----------------------|----------------------------|
| 5        | Truncated Poisson (1) | 5                          |
| 10       | Truncated Poisson (1) | 4                          |
| 15       | Truncated Poisson (1) | 8                          |

: **Table 2.** Results ACS 2015

```{r}
#| echo: true
#| eval: true
#| output: false

#ACS 2019
res_acs19_5<-res_all$res_acs19_5
res_acs19_10<-res_all$res_acs19_10
res_acs19_15<-res_all$res_acs19_15

Mode(res_acs19_5$K.mcmc)[1]
Mode(res_acs19_10$K.mcmc)[1]
Mode(res_acs19_15$K.mcmc)[1]
```

| **Kmax** | **Cluster Prior**     | **Most Probable K (mapK)** |
|----------|-----------------------|----------------------------|
| 5        | Truncated Poisson (1) | 5                          |
| 10       | Truncated Poisson (1) | 6                          |
| 15       | Truncated Poisson (1) | 8                          |

: **Table 3.** Results ACS 2019

### Explore output

##### (1) Trace plots-selecting a cluster at random for examination- Example when Kmax = 5

```{r}
#| eval: false
set.seed(2020) #year-month-day
#-------Explore output---------
mapK<-Mode(res_5$K.mcmc)[1]  #tells you mapK
n_ses<-ncol(censusdata_bin$acs5_2010_bin)

## (1) Trace plots for convergence exploration -- select a cluster at random
clusterran<-sample(1:mapK, size = 1)
clustersel<-c(paste0("theta", sep=".", clusterran, sep=".",1:n_ses), paste("p", clusterran, sep = "."))
params_est<-res_5$parameters.ecr.mcmc

#Filename is for most probable K,not the cluster being plotted
MCMCtrace(params_est[,clustersel], filename = paste("MCMCtrace_mapK", mapK, sep = "_"), wd = "./Figures")
```

##### (2) Illustrate the sampled values of K per chain according to the Poisson and uniform prior distribution using data from K.allChains--- This we can do last if necessary, otherwise we don't run it

```{r}
#| eval: false
poiKallchains<-read.table(file = "/homes6/carmen/Other projects/acs10_res_poiunif_demo/K.allChains.txt",header = T)

poiKallchains$m <-as.numeric(row.names(poiKallchains))
poiKallchains1<-poiKallchains %>% pivot_longer(cols = 1:4, names_to ="Chain", values_to = "K")
#this plot shows the generated values of K per heated chain-- note chain 1 is the original (^1)
poiKallchains1 %>% ggplot(aes(x = m, y = K, col = as.factor(Chain))) + 
  geom_line() + 
  ggtitle("MC^3 Sampler Poi-Unif") + 
  xlab("mcmc cycle")

```

### **Plots** (Patterns for ACS 2006-2010)

```{r}
#Import functions from plots.R
source("plots.R")
library(wesanderson)
library(viridis)
sesvars<-c("Two People Per Room","Lack of complete Plumbing", "Median Household Income", ">= Bacherlor's Degree", "Below Poverty Line", "< High School",
           "Female Household", ">= High School","No Vehicle","Owner", "Renter", "Unemployment","White Collar Occupation", "SNAP Benefits")


# Other color options
viridis_palette <- viridis(14)
custom_colors <- c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", 
                   "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf",
                   "#ff0000", "#00ff00", "#0000ff", "#ffff00")

# Generate 14 pastel colors
pastel_palette1 <- generate_pastel_colors(14)
pastel_palette2<-generate_pastel_colors(4)

```

```{r}
#| layout-ncol: 2
#| fig-width: 10
#| fig-height: 10
#| fig-cap: 
#|   - "Individual Neighborhood SES variables"
#|   -  "Grouped Neighborhood  SES variables"
#Kmax = 5
mapK<-Mode(res_5$K.mcmc)[1]  #tells you mapK
fig_title = paste("Success Probabilities when mapK=", mapK, sep="")
dat_5<-preparedat_fig(res_5,mapK,sesvars)
p_5_indiv<-plot_thetakj_indiv(prob_est_long = dat_5, mapK,color_palette = pastel_palette1, fig_title)
p_5_group<-plot_thetakj_group(prob_est_long = dat_5, mapK,color_palette = pastel_palette2, fig_title)

p_5_indiv
p_5_group
```

```{r}
#Class probabilities
stats<-cbind(summary(res_5$parameters.ecr.mcmc)$statistics[,c(1,2)], summary(res_5$parameters.ecr.mcmc)$quantiles[,c(1,5)])

tail(stats, mapK) %>% kable()

```

```{r}
#| layout-ncol: 2
#| fig-width: 10
#| fig-height: 10
#| fig-cap: 
#|   - "Individual Neighborhood SES variables"
#|   -  "Grouped Neighborhood  SES variables"
#Kmax = 10
mapK<-Mode(res_10$K.mcmc)[1]  #tells you mapK
fig_title = paste("Success Probabilities when mapK=", mapK, sep="")
dat_10<-preparedat_fig(res_10,mapK,sesvars)
p_10_indiv<-plot_thetakj_indiv(prob_est_long = dat_10, mapK,color_palette = pastel_palette1, fig_title)
p_10_group<-plot_thetakj_group(prob_est_long = dat_10, mapK,color_palette = pastel_palette2, fig_title)

p_10_indiv
p_10_group

```

```{r}
#Class probabilities
stats<-cbind(summary(res_10$parameters.ecr.mcmc)$statistics[,c(1,2)], summary(res_10$parameters.ecr.mcmc)$quantiles[,c(1,5)])

tail(stats, mapK) %>% kable()

```

```{r}
#| layout-ncol: 2
#| fig-width: 10
#| fig-height: 10
#| fig-cap: 
#|   - "Individual Neighborhood SES variables"
#|   -  "Grouped Neighborhood  SES variables"
#Kmax = 15
mapK<-Mode(res_15$K.mcmc)[1]  #tells you mapK
fig_title = paste("Success Probabilities when mapK=", mapK, sep="")
dat_15<-preparedat_fig(res_15,mapK,sesvars)
p_15_indiv<-plot_thetakj_indiv(prob_est_long = dat_15, mapK,color_palette = pastel_palette1, fig_title)
p_15_group<-plot_thetakj_group(prob_est_long = dat_15, mapK,color_palette = pastel_palette2, fig_title)
p_15_indiv
p_15_group
```

```{r}
#Class probabilities
stats<-cbind(summary(res_15$parameters.ecr.mcmc)$statistics[,c(1,2)], summary(res_15$parameters.ecr.mcmc)$quantiles[,c(1,5)])

tail(stats, mapK) %>% kable()
```

### **Plots** (Patterns for ACS 2015)

```{r}
#| layout-ncol: 2
#| fig-width: 10
#| fig-height: 10
#| fig-cap: 
#|   - "Individual Neighborhood SES variables"
#|   -  "Grouped Neighborhood  SES variables"
#Kmax = 5
mapK<-Mode(res_acs15_5$K.mcmc)[1]  #tells you mapK
fig_title = paste("Success Probabilities when mapK=", mapK, sep="")
dat_5<-preparedat_fig(res_acs15_5,mapK,sesvars)
p_5_indiv<-plot_thetakj_indiv(prob_est_long = dat_5, mapK,color_palette = pastel_palette1, fig_title)
p_5_group<-plot_thetakj_group(prob_est_long = dat_5, mapK,color_palette = pastel_palette2, fig_title)

p_5_indiv
p_5_group
```

```{r}
#Class probabilities
stats<-cbind(summary(res_acs15_5$parameters.ecr.mcmc)$statistics[,c(1,2)], summary(res_acs15_5$parameters.ecr.mcmc)$quantiles[,c(1,5)])

tail(stats, mapK) %>% kable()

```

```{r}
#| layout-ncol: 2
#| fig-width: 10
#| fig-height: 10
#| fig-cap: 
#|   - "Individual Neighborhood SES variables"
#|   -  "Grouped Neighborhood  SES variables"
#Kmax = 10
mapK<-Mode(res_acs15_10$K.mcmc)[1]  #tells you mapK
fig_title = paste("Success Probabilities when mapK=", mapK, sep="")
dat_10<-preparedat_fig(res_acs15_10,mapK,sesvars)
p_10_indiv<-plot_thetakj_indiv(prob_est_long = dat_10, mapK,color_palette = pastel_palette1, fig_title)
p_10_group<-plot_thetakj_group(prob_est_long = dat_10, mapK,color_palette = pastel_palette2, fig_title)

p_10_indiv
p_10_group
```

```{r}
#Class probabilities
stats<-cbind(summary(res_acs15_10$parameters.ecr.mcmc)$statistics[,c(1,2)], summary(res_acs15_10$parameters.ecr.mcmc)$quantiles[,c(1,5)])

tail(stats, mapK) %>% kable()

```

```{r}
#| layout-ncol: 2
#| fig-width: 10
#| fig-height: 10
#| fig-cap: 
#|   - "Individual Neighborhood SES variables"
#|   -  "Grouped Neighborhood  SES variables"
#Kmax = 15
mapK<-Mode(res_acs15_15$K.mcmc)[1]  #tells you mapK
fig_title = paste("Success Probabilities when mapK=", mapK, sep="")
dat_15<-preparedat_fig(res_acs15_15,mapK,sesvars)
p_15_indiv<-plot_thetakj_indiv(prob_est_long = dat_15, mapK,color_palette = pastel_palette1, fig_title)
p_15_group<-plot_thetakj_group(prob_est_long = dat_15, mapK,color_palette = pastel_palette2, fig_title)
p_15_indiv
p_15_group

```

```{r}
#Class probabilities
stats<-cbind(summary(res_acs15_15$parameters.ecr.mcmc)$statistics[,c(1,2)], summary(res_acs15_15$parameters.ecr.mcmc)$quantiles[,c(1,5)])

tail(stats, mapK) %>% kable()
```
